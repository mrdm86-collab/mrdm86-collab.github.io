---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { ArrowLeft } from 'lucide-react';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => data.lang === 'zh');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

// è¿‡æ»¤å‡ºh2-h6çº§åˆ«çš„æ ‡é¢˜ç”¨äºç›®å½•
const tocHeadings = headings.filter(h => h.depth >= 2 && h.depth <= 6);

// è·å–æ–‡æ¡£åç§°
const docName = post.data.title || 'æ–‡æ¡£';
---

<Layout title={post.data.title} lang="zh">
  <div class="min-h-screen bg-stone-50 dark:bg-neutral-900"> {/* ç»Ÿä¸€æš—é»‘èƒŒæ™¯è‰² */}
    {/* å…³é”®ï¼šå›ºå®šå®¹å™¨ï¼Œé«˜åº¦ = è§†å£ - é¡¶éƒ¨å¯¼èˆªé«˜åº¦ï¼ˆå‡è®¾å¯¼èˆªé«˜16 = 4remï¼‰ */}
    <div class="fixed inset-x-0 top-16 bottom-0 flex">
      {/* å·¦ä¾§ç›®å½•æ  - ç»Ÿä¸€èƒŒæ™¯è‰²ï¼Œæ¶ˆé™¤åˆ†å±‚ */}
      <aside class="w-72 h-full bg-white dark:bg-neutral-900 border-r border-neutral-700 flex flex-col"> {/* ç»Ÿä¸€èƒŒæ™¯ */}
        {/* æ·»åŠ é¡¶éƒ¨å¤–è¾¹è·ï¼Œè®©æŒ‰é’®ä¸‹ç§» */}
        <div class="mt-3"></div>
        
        {/* è¿”å›çŸ¥è¯†åº“ */}
        <div class="px-4 py-4 flex-shrink-0">
          <a href="/archives" class="flex items-center text-sm text-stone-600 dark:text-stone-300 hover:text-teal-600 dark:hover:text-teal-400 transition-colors">
            <ArrowLeft class="w-4 h-4 mr-2" />
            è¿”å›çŸ¥è¯†åº“
          </a>
        </div>
        
        {/* åˆ†å‰²çº¿ - æš—é»‘æ¨¡å¼ä¸‹è°ƒæš— */}
        <div class="border-t border-stone-200 dark:border-neutral-700 flex-shrink-0"></div>
        
        {/* æ–‡ç« ç›®å½•æ ‡é¢˜ */}
        <div class="px-4 py-3 flex-shrink-0">
          <h3 class="text-sm font-semibold text-stone-900 dark:text-stone-100">
            ğŸ“– æ–‡ç« ç›®å½•
          </h3>
        </div>
        
        {/* æ–‡æ¡£åç§° - æš—é»‘æ¨¡å¼ä¸‹è°ƒæš—æ–‡å­— */}
        <div class="px-4 pb-2 flex-shrink-0">
          <div class="text-sm font-semibold text-stone-800 dark:text-stone-200 mb-2">
            {docName}
          </div>
        </div>
        
        {/* ç›®å½•æ ‘ */}
        <nav class="flex-1 overflow-y-auto px-2 pb-4 space-y-1">
          {tocHeadings.map((heading) => (
            <a
              href={`#${heading.slug}`}
              class={`toc-link toc-item block text-sm leading-relaxed transition-all duration-200 hover:text-teal-600 dark:hover:text-teal-400
                ${heading.depth === 2 ? 'font-semibold text-stone-900 dark:text-stone-100 pl-3' : ''}
                ${heading.depth === 3 ? 'text-stone-700 dark:text-stone-300 pl-6' : ''}
                ${heading.depth === 4 ? 'text-stone-600 dark:text-stone-400 pl-9 text-xs' : ''}
                ${heading.depth === 5 ? 'text-stone-500 dark:text-stone-500 pl-12 text-xs' : ''}
                ${heading.depth === 6 ? 'text-stone-400 dark:text-stone-600 pl-14 text-xs' : ''}
              `}
              data-target-id={heading.slug}
            >
              <span class="block truncate">
                {heading.text}
              </span>
            </a>
          ))}
        </nav>
      </aside>

      {/* å³ä¾§æ­£æ–‡åŒºåŸŸ - ç»Ÿä¸€èƒŒæ™¯è‰² */}
      <main class="flex-1 h-full overflow-y-auto bg-white dark:bg-neutral-900"> {/* ç»Ÿä¸€èƒŒæ™¯ */}
        <article class="max-w-4xl mx-auto px-8 py-12">
          {/* æ–‡ç« å¤´éƒ¨ */}
          <header class="mb-8">
            {/* é¡¶éƒ¨æ—¥æœŸ */}
            <div class="flex items-center text-sm text-stone-600 dark:text-stone-400 mb-4">
              <span class="flex items-center">
                ğŸ“… 2025-12-03
              </span>
            </div>
            
            {post.data.tags && post.data.tags.length > 0 && (
              <div class="flex flex-wrap gap-2 mb-4">
                {post.data.tags.map((tag: string) => (
                  <span class="inline-block px-3 py-1 text-xs font-medium text-teal-700 dark:text-teal-300 bg-teal-100 dark:bg-teal-900/20 rounded-full">
                    {tag}
                  </span>
                ))}
              </div>
            )}
            
            <h1 class="text-3xl font-bold text-stone-900 dark:text-stone-100 mb-4">
              {post.data.title}
            </h1>
            
            {post.data.readingTime && (
              <div class="flex items-center text-sm text-stone-600 dark:text-stone-400">
                <span>{post.data.readingTime} åˆ†é’Ÿé˜…è¯»</span>
              </div>
            )}
          </header>

          {/* æ­£æ–‡å†…å®¹ */}
          <div class="prose prose-stone dark:prose-invert max-w-none">
            <Content />
          </div>
        </article>
      </main>
    </div>
  </div>

  <style is:global>
    /* === ç¦æ­¢æ•´ä¸ªé¡µé¢æ»šåŠ¨ === */
    html, body {
      overflow: hidden;
      height: 100%;
    }

    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #d6d3d1;
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a8a29e;
    }
    
    .dark ::-webkit-scrollbar-thumb {
      background: #57534e;
    }
    
    .dark ::-webkit-scrollbar-thumb:hover {
      background: #78716c;
    }
    
    /* å¹³æ»‘æ»šåŠ¨ */
    html {
      scroll-behavior: smooth;
    }
    
    /* æ ‡é¢˜é”šç‚¹åç§» */
    :target {
      scroll-margin-top: 2rem;
    }
    
    /* æ´»åŠ¨æ ‡é¢˜é«˜äº® */
    .toc-item.active {
      background-color: rgba(13, 148, 136, 0.1);
      color: #0d9488;
      font-weight: 600;
    }
    
    .dark .toc-item.active {
      background-color: rgba(94, 234, 212, 0.1);
      color: #5eead4;
    }
    
    /* é—ªçƒæ•ˆæœ */
    @keyframes highlight-flash {
      0%, 100% {
        background: transparent;
      }
      50% {
        background: linear-gradient(to right, rgba(13, 148, 136, 0.2), transparent);
      }
    }
    
    .flash-target {
      animation: highlight-flash 1.5s ease-in-out;
      border-radius: 4px;
      padding: 2px 0;
    }
    
    /* é˜²æ­¢ç‚¹å‡»æ—¶çš„é»˜è®¤é«˜äº® */
    * {
      -webkit-tap-highlight-color: transparent;
    }
    
    /* === ä»£ç å—æ ·å¼ - é»‘è‰²ä¸»é¢˜ === */
    .prose pre {
      background: #1e1e1e !important;
      border: 1px solid #333 !important;
      border-radius: 8px !important;
      padding: 1.5rem !important;
      position: relative !important;
      margin: 1.5rem 0 !important;
      overflow-x: auto !important;
    }
    
    .prose pre code {
      background: transparent !important;
      color: #d4d4d4 !important;
      font-size: 0.9rem !important;
      line-height: 1.5 !important;
    }
    
    /* === ä»£ç å—å¤åˆ¶æŒ‰é’® === */
    .code-block-wrapper {
      position: relative;
      margin: 1.5rem 0;
    }
    
    .code-copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #ccc;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 10;
    }
    
    .code-block-wrapper:hover .code-copy-btn {
      opacity: 1;
    }
    
    .code-copy-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
    }
    
    .code-copy-btn.copied {
      background: rgba(46, 204, 113, 0.3);
      color: #2ecc71;
      border-color: rgba(46, 204, 113, 0.5);
    }
  </style>
  
  <script>
    // é˜²æŠ–å‡½æ•°
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // ç²¾ç¡®æ»šåŠ¨åˆ°ç›®æ ‡å…ƒç´ 
    function scrollToTarget(targetId) {
      const targetElement = document.getElementById(targetId);
      if (!targetElement) return;
      
      // ç§»é™¤æ‰€æœ‰é—ªçƒæ•ˆæœ
      document.querySelectorAll('.flash-target').forEach(el => {
        el.classList.remove('flash-target');
      });
      
      // è®¡ç®—ç²¾ç¡®çš„æ»šåŠ¨ä½ç½®
      const elementRect = targetElement.getBoundingClientRect();
      const headerOffset = 80;
      const targetPosition = window.pageYOffset + elementRect.top - headerOffset;
      
      // æ‰§è¡Œå¹³æ»‘æ»šåŠ¨
      window.scrollTo({
        top: targetPosition,
        behavior: 'smooth'
      });
      
      // æ·»åŠ é—ªçƒæ•ˆæœ
      setTimeout(() => {
        targetElement.classList.add('flash-target');
        
        // 1.5ç§’åç§»é™¤é—ªçƒæ•ˆæœ
        setTimeout(() => {
          targetElement.classList.remove('flash-target');
        }, 1500);
      }, 300);
      
      // æ›´æ–°ç›®å½•æ´»åŠ¨çŠ¶æ€
      updateActiveTocItem(targetId);
    }
    
    // æ›´æ–°ç›®å½•çš„æ´»åŠ¨çŠ¶æ€
    function updateActiveTocItem(targetId) {
      const tocLinks = document.querySelectorAll('.toc-link');
      tocLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === `#${targetId}`) {
          link.classList.add('active');
        }
      });
    }
    
    // æŸ¥æ‰¾å½“å‰æ»šåŠ¨ä½ç½®å¯¹åº”çš„æ ‡é¢˜
    function findCurrentHeading() {
      const headings = Array.from(document.querySelectorAll('h2, h3, h4, h5, h6'));
      const scrollTop = window.pageYOffset;
      const offset = 120;
      
      // ä»åº•éƒ¨å‘ä¸ŠæŸ¥æ‰¾
      for (let i = headings.length - 1; i >= 0; i--) {
        const heading = headings[i];
        const headingTop = heading.offsetTop;
        
        if (scrollTop >= headingTop - offset) {
          return heading.getAttribute('id') || '';
        }
      }
      
      return headings[0]?.getAttribute('id') || '';
    }
    
    // === å¢å¼ºçš„ä»£ç å—å¤åˆ¶åŠŸèƒ½ ===
    function enhanceCodeBlocks() {
      // æŸ¥æ‰¾æ‰€æœ‰ä»£ç å—
      const codeBlocks = document.querySelectorAll('.prose pre');
      
      if (codeBlocks.length === 0) return;
      
      codeBlocks.forEach((block, index) => {
        // åˆ›å»ºåŒ…è£…å®¹å™¨
        const wrapper = document.createElement('div');
        wrapper.className = 'code-block-wrapper';
        
        // åˆ›å»ºå¤åˆ¶æŒ‰é’®
        const copyBtn = document.createElement('button');
        copyBtn.className = 'code-copy-btn';
        copyBtn.textContent = 'å¤åˆ¶';
        copyBtn.setAttribute('data-code-id', `code-${index}`);
        
        // å°†ä»£ç å—åŒ…è£…èµ·æ¥
        block.parentNode.insertBefore(wrapper, block);
        wrapper.appendChild(block);
        wrapper.appendChild(copyBtn);
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        copyBtn.addEventListener('click', async () => {
          const codeText = block.querySelector('code')?.textContent || '';
          
          // ç©ºå†…å®¹æ£€æŸ¥
          if (!codeText.trim()) {
            copyBtn.textContent = 'ç©ºå†…å®¹';
            setTimeout(() => {
              copyBtn.textContent = 'å¤åˆ¶';
            }, 2000);
            return;
          }
          
          try {
            // å°è¯•ä½¿ç”¨ Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
              await navigator.clipboard.writeText(codeText);
              showSuccess(copyBtn);
            } else {
              // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ execCommand
              const textArea = document.createElement('textarea');
              textArea.value = codeText;
              textArea.style.position = 'fixed';
              textArea.style.left = '-999999px';
              document.body.appendChild(textArea);
              textArea.focus();
              textArea.select();
              
              const successful = document.execCommand('copy');
              document.body.removeChild(textArea);
              
              if (successful) {
                showSuccess(copyBtn);
              } else {
                throw new Error('execCommand failed');
              }
            }
          } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            showError(copyBtn);
          }
        });
      });
    }
    
    // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸ
    function showSuccess(btn) {
      btn.textContent = 'å·²å¤åˆ¶!';
      btn.classList.add('copied');
      
      setTimeout(() => {
        btn.textContent = 'å¤åˆ¶';
        btn.classList.remove('copied');
      }, 2000);
    }
    
    // æ˜¾ç¤ºå¤åˆ¶å¤±è´¥
    function showError(btn) {
      btn.textContent = 'å¤åˆ¶å¤±è´¥';
      btn.style.background = 'rgba(231, 76, 60, 0.3)';
      btn.style.color = '#e74c3c';
      btn.style.borderColor = 'rgba(231, 76, 60, 0.5)';
      
      setTimeout(() => {
        btn.textContent = 'å¤åˆ¶';
        btn.style.background = '';
        btn.style.color = '';
        btn.style.borderColor = '';
      }, 2000);
    }
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      // å¢å¼ºä»£ç å—
      enhanceCodeBlocks();
      
      const tocLinks = document.querySelectorAll('.toc-link');
      
      // ä¸ºç›®å½•é“¾æ¥æ·»åŠ ç‚¹å‡»äº‹ä»¶
      tocLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const targetId = link.getAttribute('href')?.substring(1);
          if (!targetId) return;
          
          scrollToTarget(targetId);
        });
      });
      
      // ä½¿ç”¨é˜²æŠ–ä¼˜åŒ–æ»šåŠ¨äº‹ä»¶ç›‘å¬
      const handleScroll = debounce(() => {
        const currentId = findCurrentHeading();
        if (currentId) {
          updateActiveTocItem(currentId);
        }
      }, 100);
      
      window.addEventListener('scroll', handleScroll);
      
      // åˆå§‹åŒ–æ´»åŠ¨çŠ¶æ€
      setTimeout(() => {
        const currentId = findCurrentHeading();
        if (currentId) {
          updateActiveTocItem(currentId);
        }
      }, 300);
      
      // å¤„ç†URLå“ˆå¸Œå€¼
      if (window.location.hash) {
        const targetId = window.location.hash.substring(1);
        setTimeout(() => {
          scrollToTarget(targetId);
        }, 500);
      }
    });
  </script>
</Layout>